<!doctype html>
<html lang="en-GB">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0B1220" />
  <meta name="description" content="JerseyGo ‚Äî Parking LIVE, parks, GP clinics, dentists, pharmacies, transport and emergency." />

  <title>JerseyGo</title>

  <link rel="manifest" href="./manifest.webmanifest" />
  <link rel="icon" href="./icon.svg" type="image/svg+xml">
  <link rel="apple-touch-icon" href="./icon.svg">

  <style>
    :root{
      --bg:#070A12;
      --bg2:#0B1220;
      --card:rgba(255,255,255,.04);
      --card2:rgba(255,255,255,.06);
      --line:rgba(255,255,255,.10);
      --text:#E9EEF7;
      --muted:#A9B4C7;
      --accent:#4DA3FF;
      --good:#35D07F;
      --warn:#FFB020;
      --danger:#FF4D5E;
      --r:18px;
      --r2:22px;
      --shadow: 0 22px 50px rgba(0,0,0,.45);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color:var(--text);
      background:
        radial-gradient(900px 600px at 12% 12%, rgba(77,163,255,.22), transparent 58%),
        radial-gradient(850px 520px at 88% 10%, rgba(53,208,127,.18), transparent 58%),
        radial-gradient(920px 720px at 50% 95%, rgba(255,176,32,.12), transparent 58%),
        linear-gradient(180deg, var(--bg), var(--bg2));
      -webkit-font-smoothing:antialiased;
      text-rendering:optimizeLegibility;
    }

    a{color:inherit; text-decoration:none}
    button{font-family:inherit}

    .wrap{max-width:1180px; margin:0 auto; padding:14px}

    /* Top bar */
    header{
      position:sticky; top:0; z-index:50;
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      background: rgba(7,10,18,.72);
      border-bottom:1px solid var(--line);
    }
    .top{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; flex-wrap:wrap;
      padding:14px;
    }
    .brand{display:flex; align-items:center; gap:12px; min-width:260px}
    .brand img{width:40px; height:40px; border-radius:14px; box-shadow: 0 12px 30px rgba(0,0,0,.35)}
    .brand .t{line-height:1.05}
    .brand .t .name{font-weight:900; font-size:18px}
    .brand .t .sub{margin-top:4px; font-size:12px; color:var(--muted)}
    .actionsTop{display:flex; align-items:center; gap:10px; flex-wrap:wrap; justify-content:flex-end; width:100%}
    @media (min-width: 760px){ .actionsTop{width:auto} }

    .search{
      display:flex; align-items:center; gap:10px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      padding:12px 14px;
      border-radius:999px;
      width:min(94vw, 540px);
    }
    .search input{
      width:100%;
      border:none; outline:none; background:transparent;
      color:var(--text);
      font-size:14px;
    }
    .btn{
      border:1px solid var(--line);
      background: rgba(255,255,255,.05);
      color:var(--text);
      padding:12px 14px;
      border-radius:16px;
      cursor:pointer;
      font-weight:900;
      letter-spacing:.2px;
    }
    .btn:hover{background: rgba(255,255,255,.08)}
    .btn.primary{border-color: rgba(77,163,255,.35); background: rgba(77,163,255,.14)}
    .btn.good{border-color: rgba(53,208,127,.35); background: rgba(53,208,127,.12)}
    .btn.ghost{background: rgba(255,255,255,.03)}

    /* Layout */
    .grid{
      display:grid;
      grid-template-columns: 320px 1fr;
      gap:14px;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
    }

    .panel{
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      border-radius: var(--r2);
      overflow:hidden;
      box-shadow: var(--shadow);
    }

    .panelHd{
      padding:14px 14px;
      display:flex; align-items:center; justify-content:space-between;
      border-bottom:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
    }
    .panelHd h2{
      margin:0;
      font-size:12px;
      color:var(--muted);
      font-weight:900;
      letter-spacing:.35px;
      text-transform:uppercase;
    }
    .badge{
      font-size:12px;
      color:var(--muted);
      border:1px solid var(--line);
      padding:5px 10px;
      border-radius:999px;
      background: rgba(255,255,255,.02);
    }
    .badge.liveOk{border-color: rgba(53,208,127,.35); color: rgba(233,238,247,.95); background: rgba(53,208,127,.10)}
    .badge.liveBad{border-color: rgba(255,77,94,.35); color: rgba(233,238,247,.95); background: rgba(255,77,94,.10)}
    .badge.liveWait{border-color: rgba(255,176,32,.35); color: rgba(233,238,247,.95); background: rgba(255,176,32,.10)}

    /* Categories */
    .cats{padding:10px}
    .cat{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
      padding:12px 12px;
      border-radius:16px;
      cursor:pointer;
      border:1px solid transparent;
    }
    .cat:hover{background: rgba(255,255,255,.04)}
    .cat.active{
      background: rgba(77,163,255,.10);
      border-color: rgba(77,163,255,.35);
    }
    .catLeft{display:flex; align-items:center; gap:10px}
    .catIcon{
      width:28px; height:28px;
      display:grid; place-items:center;
      border:1px solid var(--line);
      border-radius:10px;
      background: rgba(255,255,255,.03);
    }
    .catName{font-weight:900}
    .catCount{min-width:34px; text-align:center}

    /* Main */
    .content{padding:14px}
    .hero{
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border-radius: var(--r2);
      padding:14px;
      display:flex; align-items:flex-start; justify-content:space-between; gap:14px; flex-wrap:wrap;
    }
    .hero h1{margin:0; font-size:20px}
    .hero p{margin:7px 0 0; color:var(--muted); line-height:1.35}
    .mini{font-size:12px; color:var(--muted); margin-top:10px}

    .quick{
      display:flex; gap:10px; flex-wrap:wrap;
      justify-content:flex-end;
    }
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      padding:10px 12px;
      border-radius:16px;
      font-size:13px;
      cursor:pointer;
      user-select:none;
    }
    .chip:hover{background: rgba(255,255,255,.08)}
    .chip.primary{border-color: rgba(77,163,255,.35); background: rgba(77,163,255,.12)}
    .chip.good{border-color: rgba(53,208,127,.35); background: rgba(53,208,127,.10)}

    .cards{
      margin-top:12px;
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap:12px;
    }
    @media (max-width: 820px){ .cards{grid-template-columns:1fr} }

    .card{
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      border-radius: var(--r2);
      padding:14px;
      display:flex; flex-direction:column; gap:10px;
    }
    .row{display:flex; align-items:flex-start; justify-content:space-between; gap:10px}
    .name{font-weight:950; letter-spacing:.2px}
    .meta{font-size:12px; color:var(--muted); line-height:1.35}
    .tags{display:flex; gap:8px; flex-wrap:wrap}
    .tag{
      font-size:12px;
      border:1px solid var(--line);
      padding:6px 10px;
      border-radius:999px;
      color:var(--muted);
      background: rgba(255,255,255,.02);
    }
    .actions{display:flex; gap:8px; flex-wrap:wrap; margin-top:auto}

    .favBtn{
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
      font-weight:900;
    }
    .favBtn.on{border-color: rgba(77,163,255,.35); background: rgba(77,163,255,.14)}
    .favBtn:hover{background: rgba(255,255,255,.08)}

    /* Toast */
    .toast{
      position:fixed; left:50%; bottom:16px; transform:translateX(-50%);
      background: rgba(14,22,41,.92);
      border:1px solid var(--line);
      padding:10px 12px;
      border-radius:14px;
      color:var(--text);
      display:none;
      max-width: min(92vw, 560px);
      box-shadow: 0 18px 45px rgba(0,0,0,.45);
      z-index:200;
    }
    .toast.show{display:block}

    footer{
      color:rgba(169,180,199,.8);
      font-size:12px;
      text-align:center;
      padding:14px 0 2px;
    }
  </style>
</head>

<body>
<header>
  <div class="wrap top">
    <div class="brand">
      <img src="./icon.svg" alt="JerseyGo icon">
      <div class="t">
        <div class="name">JerseyGo</div>
        <div class="sub">Parking LIVE ‚Ä¢ Parks ‚Ä¢ GP Clinics ‚Ä¢ Dentists ‚Ä¢ Pharmacies ‚Ä¢ Transport ‚Ä¢ Emergency</div>
      </div>
    </div>

    <div class="actionsTop">
      <div class="search">
        <span style="opacity:.9">üîé</span>
        <input id="q" placeholder="Search: car park, spaces, GP, dentist, pharmacy‚Ä¶" autocomplete="off" />
      </div>
      <button id="favToggle" class="btn good">‚òÖ Favourites</button>
      <button id="nearMeBtn" class="btn primary">üìç Near me</button>
      <button id="resetBtn" class="btn ghost">Reset</button>
    </div>
  </div>
</header>

<div class="wrap grid">
  <aside class="panel">
    <div class="panelHd">
      <h2>Categories</h2>
      <span id="countVisible" class="badge">0</span>
    </div>
    <div id="cats" class="cats"></div>

    <div class="panelHd" style="border-top:1px solid var(--line);">
      <h2>Live status</h2>
      <span id="liveStatus" class="badge liveWait">LIVE‚Ä¶</span>
    </div>
    <div style="padding:12px 14px; color:var(--muted); font-size:12px; line-height:1.45;">
      Live car park spaces update automatically. If ‚ÄúLIVE ‚úï‚Äù appears, the app will still show fallback car parks.
    </div>
  </aside>

  <main class="panel">
    <div class="content">
      <div class="hero">
        <div>
          <h1 id="viewTitle">All services</h1>
          <p id="viewDesc">Direct actions: Call ‚Ä¢ Email ‚Ä¢ Maps ‚Ä¢ Official pages.</p>
          <div id="statsLine" class="mini">Loading‚Ä¶</div>
        </div>

        <div class="quick">
          <a class="chip primary" href="https://www.gov.je/Travel/Motoring/Parking/pages/carparkspaces.aspx" target="_blank" rel="noopener">üÖøÔ∏è Official Live</a>
          <a class="chip" href="https://www.gov.je/Health/DoctorDentist/Doctors/pages/gpsurgerylist.aspx" target="_blank" rel="noopener">üè• GP list</a>
          <a class="chip" href="https://www.gov.je/Leisure/ParksGardens/pages/index.aspx" target="_blank" rel="noopener">üå≥ Parks</a>
          <a class="chip" href="https://www.gov.je/Health/DoctorDentist/PharmacistsChemists/pages/pharmacyopeninghours.aspx" target="_blank" rel="noopener">üíä Pharmacy hours</a>
        </div>
      </div>

      <div id="cards" class="cards"></div>

      <footer>
        Emergency: call <b>999</b> or <b>112</b> ‚Ä¢ JerseyGo (unofficial directory; uses official sources when possible)
      </footer>
    </div>
  </main>
</div>

<div id="toast" class="toast"></div>

<script>
/* =========================================================
   JerseyGo ‚Äî Single-file PWA (GitHub Pages)
   ========================================================= */

const $ = (id)=>document.getElementById(id);
const norm = (s)=> (s||"").toLowerCase().trim();
const escapeHtml = (s)=> (s||"")
  .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
  .replaceAll('"',"&quot;").replaceAll("'","&#039;");

const toast = (msg)=>{
  const t = $("toast");
  t.textContent = msg;
  t.classList.add("show");
  clearTimeout(window.__toast);
  window.__toast = setTimeout(()=>t.classList.remove("show"), 1600);
};

const telHref = (phone)=>{
  const cleaned = (phone||"").replace(/[^\d+]/g,"");
  return cleaned ? ("tel:" + cleaned) : "#";
};
const mailHref = (email)=> email ? ("mailto:" + email) : "#";
const mapsUrl = (query)=> `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(query || "Jersey")}`;

const CATEGORY_ORDER = ["Emergency","Parking","Parks","GP Clinics","Dentists","Pharmacies","Transport","Utilities"];
const LS_FAVS = "jerseygo:favs:v1";

const state = {
  q: "",
  category: "All",
  showFavs: false,
  favs: new Set(JSON.parse(localStorage.getItem(LS_FAVS) || "[]"))
};

function catIcon(cat){
  switch(cat){
    case "All": return "üß≠";
    case "Emergency": return "üö®";
    case "Parking": return "üÖøÔ∏è";
    case "Parks": return "üå≥";
    case "GP Clinics": return "üè•";
    case "Dentists": return "ü¶∑";
    case "Pharmacies": return "üíä";
    case "Transport": return "üöå";
    case "Utilities": return "‚ö°";
    default: return "‚Ä¢";
  }
}

/* -------------------------
   Static directories (editable)
   ------------------------- */

const SERVICES_STATIC = [
  {
    id:"emergency-999",
    category:"Emergency",
    name:"Emergency services",
    desc:"Police ‚Ä¢ Fire ‚Ä¢ Ambulance ‚Äî for emergencies call 999 or 112.",
    tags:["999","112"],
    phone:"999",
    links:[{label:"gov.je contacts", url:"https://www.gov.je/pages/contacts.aspx"}],
    mapsQuery:"Police Jersey"
  },

  // Parking official hubs
  {
    id:"parking-hub",
    category:"Parking",
    name:"Parking (official hub)",
    desc:"Rules, permits, EV, car parks and more.",
    tags:["parking","rules"],
    links:[{label:"Parking hub (gov.je)", url:"https://www.gov.je/Travel/Motoring/Parking/pages/index.aspx"}],
    mapsQuery:"Parking St Helier"
  },
  {
    id:"parking-paybyphone",
    category:"Parking",
    name:"PayByPhone Parking",
    desc:"Pay parking by phone ‚Äî official info + locations.",
    tags:["PayByPhone","payment"],
    links:[
      {label:"Info (gov.je)", url:"https://www.gov.je/Travel/Motoring/Parking/PayForParking/pages/paybyphoneapp.aspx"},
      {label:"Locations", url:"https://www.paybyphone.co.uk/locations/states-of-jersey"}
    ],
    mapsQuery:"PayByPhone Jersey"
  },

  // Parks
  {
    id:"parks-index",
    category:"Parks",
    name:"Parks & gardens (official index)",
    desc:"Official list of public parks and gardens.",
    tags:["official"],
    links:[{label:"gov.je", url:"https://www.gov.je/Leisure/ParksGardens/pages/index.aspx"}],
    mapsQuery:"Parks Jersey"
  },
  {
    id:"parks-howard",
    category:"Parks",
    name:"Howard Davis Park",
    desc:"Public park & gardens (official info).",
    tags:["St Saviour"],
    links:[{label:"Info", url:"https://www.gov.je/Leisure/ParksGardens/pages/howarddavispark.aspx"}],
    mapsQuery:"Howard Davis Park Jersey"
  },
  {
    id:"parks-millennium",
    category:"Parks",
    name:"Millennium Town Park",
    desc:"Public town park (official info).",
    tags:["St Helier"],
    links:[{label:"Info", url:"https://www.gov.je/Leisure/ParksGardens/pages/millenniumtownpark.aspx"}],
    mapsQuery:"Millennium Town Park Jersey"
  },
  {
    id:"parks-coronation",
    category:"Parks",
    name:"Coronation Park",
    desc:"Millbrook park area (official info).",
    tags:["Millbrook","St Lawrence"],
    links:[{label:"Info", url:"https://www.gov.je/Leisure/ParksGardens/pages/coronationpark.aspx"}],
    mapsQuery:"Coronation Park Jersey"
  },

  // Pharmacies
  {
    id:"pharm-hours",
    category:"Pharmacies",
    name:"Pharmacy opening hours",
    desc:"Official list of pharmacy opening hours.",
    tags:["official","opening hours"],
    links:[{label:"gov.je", url:"https://www.gov.je/Health/DoctorDentist/PharmacistsChemists/pages/pharmacyopeninghours.aspx"}],
    mapsQuery:"Pharmacy St Helier"
  },

  // Transport
  {
    id:"transport-liberty",
    category:"Transport",
    name:"LibertyBus",
    desc:"Routes, timetables and tickets.",
    tags:["bus","timetable"],
    links:[{label:"Website", url:"https://libertybus.je/"}],
    mapsQuery:"Liberation Station Jersey"
  },
  {
    id:"transport-airport",
    category:"Transport",
    name:"Jersey Airport",
    desc:"Flights, departures and contact.",
    tags:["airport"],
    links:[{label:"Website", url:"https://www.jerseyairport.com/"}],
    mapsQuery:"Jersey Airport"
  },

  // Utilities
  {
    id:"util-electricity",
    category:"Utilities",
    name:"Jersey Electricity",
    desc:"Electricity provider.",
    tags:["utilities"],
    links:[{label:"Website", url:"https://www.jec.co.uk/"}],
    mapsQuery:"Jersey Electricity"
  },
  {
    id:"util-water",
    category:"Utilities",
    name:"Jersey Water",
    desc:"Water services.",
    tags:["utilities"],
    links:[{label:"Website", url:"https://www.jerseywater.je/"}],
    mapsQuery:"Jersey Water"
  }
];

/* -------------------------
   GP Clinics (in-app list)
   ------------------------- */
const GP_CLINICS = [
  { id:"gp-clifden", name:"Clifden Surgery", address:"7 Nelson Street, St Helier, JE2 4TL", phone:"+44 1534 726705", email:"reception@clifden.gpnet.je", maps:"Clifden Surgery 7 Nelson Street St Helier Jersey" },
  { id:"gp-7david", name:"7 David Place", address:"7 David Place, St Helier, JE2 4TD", phone:"+44 1534 736666", email:"practice@7davidplace.gpnet.je", maps:"7 David Place St Helier Jersey" },
  { id:"gp-windsor", name:"Windsor Medical Practice", address:"Suite 3.05, The Lido Medical Centre, St Saviours Road, St Saviour, JE2 7LA", phone:"+44 1534 732341", email:"practice@windsor.gpnet.je", maps:"Windsor Medical Practice Lido Medical Centre Jersey" },
  { id:"gp-lister-town", name:"Lister Surgery (Town)", address:"8 The Parade, St Helier, JE2 3QP", phone:"+44 1534 736336", email:"admin@listersurgery.gpnet.je", maps:"Lister Surgery 8 The Parade St Helier Jersey" },
  { id:"gp-lister-quennevais", name:"Lister Surgery (Quennevais)", address:"Quennevais Parade, St Brelade, JE3 8FX", phone:"+44 1534 741641", email:"admin@listersurgery.gpnet.je", maps:"Lister Surgery Quennevais Parade Jersey" },
  { id:"gp-routedufort", name:"Route du Fort Surgery", address:"Lido Medical Centre, St Saviours Road, St Saviour, JE2 7LA", phone:"+44 1534 731421", email:"routedufort@rdf.gpnet.je", maps:"Route du Fort Surgery Lido Medical Centre Jersey" },
  { id:"gp-healthplus", name:"Health Plus", address:"Queens Road Health Centre, Queens Road, St Helier, JE2 4HY", phone:"+44 1534 733322", email:"healthplus@healthplus.gpnet.je", maps:"Queens Road Health Centre Jersey" },
  { id:"gp-indigo-town", name:"Indigo Medical (Town)", address:"Indigo House, 2-8 Oxford Road, St Helier, JE1 4HB", phone:"+44 1534 730541", email:"indigomedical@indigo.gpnet.je", maps:"Indigo House Oxford Road St Helier Jersey" },
  { id:"gp-indigo-leodis", name:"Indigo Medical (Leodis)", address:"Leodis, Route de Quennevais, St Brelade, JE3 8LL", phone:"+44 1534 498775", email:"indigomedical@indigo.gpnet.je", maps:"Leodis Route de Quennevais St Brelade Jersey" },
  { id:"gp-cleveland-town", name:"Cleveland Clinic (Town)", address:"12 Cleveland Road, St Helier, JE1 4HD", phone:"+44 1534 722381", email:"town@clevelandclinic.gpnet.je", maps:"Cleveland Clinic 12 Cleveland Road St Helier Jersey" },
  { id:"gp-cleveland-redhouses", name:"Cleveland Clinic (Red Houses)", address:"Unit B, Millennium Properties Arcade, Red Houses, JE3 8GP", phone:"+44 1534 745511", email:"accounts@clevelandclinic.gpnet.je", maps:"Cleveland Clinic Red Houses Jersey" },
  { id:"gp-imc-gloucester", name:"Island Medical Centre (St Helier)", address:"14 Gloucester Street, St Helier, JE2 3QR", phone:"+44 1534 516151", email:"info@imc.je", maps:"Island Medical Centre 14 Gloucester Street Jersey" },
  { id:"gp-imc-redhouses", name:"Island Medical Centre (Red Houses)", address:"Centre Point, Red Houses, St Brelade, JE3 8LB", phone:"+44 1534 516152", email:"info@imc.je", maps:"Island Medical Centre Red Houses Jersey" },
  { id:"gp-imc-stjohn", name:"Island Medical Centre (St John)", address:"Temple Court, St John, JE3 4BJ", phone:"+44 1534 516153", email:"info@imc.je", maps:"Temple Court St John Jersey" },
  { id:"gp-imc-grouville", name:"Island Medical Centre (Grouville)", address:"Fernlea, La Grande Route des Sablons, Grouville, JE3 9FR", phone:"+44 1534 516154", email:"info@imc.je", maps:"La Grande Route des Sablons Grouville Jersey" },
  { id:"gp-castlequay", name:"Castle Quay Medical Practice", address:"La Rue De L'Etau, St Helier, JE2 3EH", phone:"+44 1534 833833", email:"accounts@castlequay.gpnet.je", maps:"Castle Quay Medical Practice Jersey" },
  { id:"gp-firstmedical-bath", name:"First Medical (Bath Street)", address:"87-91 Bath Street, St Helier, JE2 4SU", phone:"+44 1534 723318", email:"admin@firstmedical.gpnet.je", maps:"Bath Street Medical Centre Jersey" },
  { id:"gp-firstmedical-stpeter", name:"First Medical (St Peter)", address:"Rue De L'Eglise, St Peter, JE3 7AG", phone:"+44 1534 723318", email:"admin@firstmedical.gpnet.je", maps:"Rue De L'Eglise St Peter Jersey" },
  { id:"gp-firstmedical-newera", name:"First Medical (New Era)", address:"New Era (Georgetown)", phone:"+44 1534 723318", email:"admin@firstmedical.gpnet.je", maps:"New Era Georgetown Jersey" },
  { id:"gp-stmartin", name:"St Martin Surgery", address:"La Vielle Ecole, St Martin, JE3 6HW", phone:"+44 1534 500090", email:"practice@stmartinsurgery.gpnet.je", maps:"St Martin Surgery Jersey" },
  { id:"gp-comovilla", name:"Como Villa Surgery", address:"7 Clarendon Road, St Helier, JE2 3YS", phone:"+44 1534 870151", email:"reception@atlantic.gpnet.je", maps:"Como Villa Surgery Clarendon Road Jersey" },
  { id:"gp-lido", name:"Lido Medical Practice", address:"The Lido Medical Centre, St Saviours Road, St Saviour", phone:"+44 1534 723892", email:"lidomedicalpractice@lmp.gpnet.je", maps:"Lido Medical Centre St Saviours Road Jersey" }
];

/* -------------------------
   Dentists (in-app list)
   ------------------------- */
const DENTISTS = [
  { id:"dent-hospital", name:"Dental Department (General Hospital)", address:"General Hospital, Newgate Street, St Helier, JE1 3QS", phone:"01534 445300", email:"dental@health.gov.je", website:"https://www.gov.je/Health/DoctorDentist/Dentists/pages/hospital.aspx", maps:"Dental Department General Hospital Jersey" },
  { id:"dent-dentalstudio", name:"The Dental Studio", address:"Castle Quay, St Helier, JE2 3EH", phone:"01534 731113", email:"reception.desk@dentistjersey.com", website:"https://dentistjersey.je/", maps:"The Dental Studio Castle Quay Jersey" },
  { id:"dent-parade", name:"Parade Dental Group", address:"24 The Parade, St Helier, JE2 3QQ", phone:"01534 725520", email:"admin@paradedentalpractice.co.uk", website:"https://paradedentalpractice.co.uk/", maps:"Parade Dental Practice 24 The Parade Jersey" },
  { id:"dent-smile", name:"@Smile Dental Clinic", address:"14 Gloucester Street, St Helier, JE2 3QR", phone:"01534 745467", email:"info@at-smile.co.uk", website:"https://www.at-smile.co.uk/", maps:"@Smile dental clinic Gloucester Street Jersey" },
  { id:"dent-indigo", name:"Indigo Dental Practice", address:"Indigo House, Oxford Road, St Helier, JE1 4HB", phone:"01534 723556", email:"info@indigodentalpractice.com", website:"https://indigodentalpractice.com/", maps:"Indigo Dental Practice Oxford Road Jersey" },
  { id:"dent-excellence", name:"Dental Excellence", address:"Quennevais Parade, St Brelade, JE3 8FX", phone:"01534 747780", email:"contact@dentalexcellence.je", website:"https://dentalexcellence.je/", maps:"Dental Excellence Quennevais Parade Jersey" },
  { id:"dent-laretraite", name:"La Retraite Jersey Dental Care", address:"St Peter, JE3 7AH", phone:"01534 483838", email:"reception@lrjerseydentalcare.com", website:"https://www.lrjerseydentalcare.com/", maps:"La Retraite Jersey Dental Care St Peter" }
];

/* -------------------------
   Live Parking (per car park)
   ------------------------- */
const GOVJE_LIVE_URL = "https://www.gov.je/Travel/Motoring/Parking/pages/carparkspaces.aspx";

// Multi-storey live counters (fallback list always shown)
const LIVE_FALLBACK = [
  { code:"charles", name:"Charles Street", mapsQuery:"Charles Street car park St Helier Jersey" },
  { code:"green", name:"Green Street", mapsQuery:"Green Street car park St Helier Jersey" },
  { code:"lesjardin", name:"Les Jardin", mapsQuery:"Les Jardin car park St Helier Jersey" },
  { code:"minden", name:"Minden Place", mapsQuery:"Minden Place car park St Helier Jersey" },
  { code:"patriotic", name:"Patriotic Street", mapsQuery:"Patriotic Street car park St Helier Jersey" },
  { code:"pier", name:"Pier Road", mapsQuery:"Pier Road car park St Helier Jersey" },
  { code:"sand", name:"Sand Street", mapsQuery:"Sand Street car park St Helier Jersey" }
];

let LIVE_SPACES = LIVE_FALLBACK.map(x => ({...x, spaces:"‚Äî", open:true, status:"LIVE"}));

function buildLiveParkingServices(){
  return LIVE_SPACES.map(x => ({
    id: "live-" + x.code,
    category: "Parking",
    name: `LIVE: ${x.name}`,
    desc: `${x.open ? "Open" : "Closed"} ‚Ä¢ Spaces available: ${x.spaces}`,
    tags: ["live spaces","multi-storey"],
    links: [
      { label:"Official LIVE (gov.je)", url: GOVJE_LIVE_URL }
    ],
    mapsQuery: x.mapsQuery
  }));
}

/* -------------------------
   Build services
   ------------------------- */
function buildGPServices(){
  return GP_CLINICS.map(g => ({
    id: g.id,
    category: "GP Clinics",
    name: g.name,
    desc: g.address,
    tags: ["GP","clinic"],
    phone: g.phone,
    email: g.email,
    links: [{ label:"Official GP list (gov.je)", url:"https://www.gov.je/Health/DoctorDentist/Doctors/pages/gpsurgerylist.aspx" }],
    mapsQuery: g.maps
  }));
}

function buildDentistServices(){
  return DENTISTS.map(d => ({
    id: d.id,
    category: "Dentists",
    name: d.name,
    desc: d.address,
    tags: ["dentist","dental"],
    phone: d.phone,
    email: d.email,
    links: d.website ? [{ label:"Website", url:d.website }] : [],
    mapsQuery: d.maps
  }));
}

function allServices(){
  return [
    ...buildLiveParkingServices(),
    ...SERVICES_STATIC,
    ...buildGPServices(),
    ...buildDentistServices()
  ];
}

/* -------------------------
   Search/filter
   ------------------------- */
function matchesQuery(svc, q){
  if(!q) return true;
  const hay = [
    svc.name, svc.desc, svc.category,
    ...(svc.tags||[]),
    svc.phone||"",
    svc.email||"",
    ...(svc.links||[]).map(x=>x.label+" "+x.url),
    svc.mapsQuery||""
  ].join(" ");
  return norm(hay).includes(norm(q));
}

function visibleServices(){
  return allServices()
    .filter(s => state.category === "All" ? true : s.category === state.category)
    .filter(s => state.showFavs ? state.favs.has(s.id) : true)
    .filter(s => matchesQuery(s, state.q));
}

/* -------------------------
   Render
   ------------------------- */
function renderCats(){
  const merged = allServices();
  const counts = merged.reduce((acc, s)=>{ acc[s.category]=(acc[s.category]||0)+1; return acc; },{});
  const cats = ["All", ...CATEGORY_ORDER.filter(c => counts[c])];

  $("cats").innerHTML = cats.map(cat=>{
    const count = cat==="All" ? merged.length : (counts[cat]||0);
    const active = (state.category===cat) ? "active" : "";
    return `
      <div class="cat ${active}" data-cat="${escapeHtml(cat)}">
        <div class="catLeft">
          <div class="catIcon">${catIcon(cat)}</div>
          <div class="catName">${escapeHtml(cat)}</div>
        </div>
        <div class="badge catCount">${count}</div>
      </div>
    `;
  }).join("");

  [...document.querySelectorAll(".cat[data-cat]")].forEach(el=>{
    el.addEventListener("click", ()=>{
      state.category = el.getAttribute("data-cat");
      renderAll(false);
    });
  });
}

function renderHeader(){
  const list = visibleServices();
  const title = (state.category==="All") ? "All services" : state.category;
  $("viewTitle").textContent = `${title} (${list.length})`;

  if(state.category === "Parking"){
    $("viewDesc").textContent = "Live multi-storey spaces + official parking links.";
  } else if(state.category === "GP Clinics"){
    $("viewDesc").textContent = "GP clinics with direct Call / Email / Maps + official list link.";
  } else if(state.category === "Dentists"){
    $("viewDesc").textContent = "Dentists with direct Call / Email / Maps + websites.";
  } else if(state.showFavs){
    $("viewDesc").textContent = "Your saved services for one-tap access.";
  } else {
    $("viewDesc").textContent = "Direct actions: Call ‚Ä¢ Email ‚Ä¢ Maps ‚Ä¢ Official pages.";
  }

  $("statsLine").textContent = `Showing ${list.length} ‚Ä¢ Live spaces refresh every ~2 minutes`;
  $("countVisible").textContent = list.length;
}

function renderCards(){
  const list = visibleServices();
  const el = $("cards");

  if(!list.length){
    el.innerHTML = `
      <div class="card" style="grid-column:1/-1;">
        <div class="name">No results</div>
        <div class="meta">Try: ‚Äúspaces‚Äù, ‚ÄúCharles‚Äù, ‚ÄúGP‚Äù, ‚Äúdentist‚Äù, ‚Äúpharmacy‚Äù.</div>
      </div>
    `;
    return;
  }

  el.innerHTML = list.map(s=>{
    const isFav = state.favs.has(s.id);
    const tags = (s.tags||[]).slice(0,9).map(t=>`<span class="tag">${escapeHtml(String(t))}</span>`).join("");

    const phoneBtn = s.phone ? `<a class="chip" href="${telHref(s.phone)}">üìû Call</a>` : "";
    const emailBtn = s.email ? `<a class="chip" href="${mailHref(s.email)}">‚úâÔ∏è Email</a>` : "";
    const mapsBtn = `<a class="chip" href="${mapsUrl(s.mapsQuery || (s.name + " Jersey"))}" target="_blank" rel="noopener">üó∫Ô∏è Maps</a>`;
    const links = (s.links||[]).slice(0,3).map(l=>`<a class="chip primary" href="${l.url}" target="_blank" rel="noopener">‚Üó ${escapeHtml(l.label)}</a>`).join("");

    return `
      <div class="card">
        <div class="row">
          <div>
            <div class="name">${escapeHtml(s.name)}</div>
            <div class="meta">${escapeHtml(s.desc || "")}</div>
          </div>
          <button class="favBtn ${isFav ? "on" : ""}" data-fav="${escapeHtml(s.id)}">${isFav ? "‚òÖ" : "‚òÜ"}</button>
        </div>

        <div class="tags">${tags}</div>

        <div class="actions">
          ${phoneBtn}
          ${emailBtn}
          ${mapsBtn}
          ${links}
          <button class="chip" type="button" data-copy="${escapeHtml(s.id)}">üìã Copy</button>
        </div>
      </div>
    `;
  }).join("");

  [...document.querySelectorAll("[data-fav]")].forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const id = btn.getAttribute("data-fav");
      if(state.favs.has(id)){
        state.favs.delete(id);
        toast("Removed from favourites");
      }else{
        state.favs.add(id);
        toast("Saved to favourites");
      }
      localStorage.setItem(LS_FAVS, JSON.stringify([...state.favs]));
      renderAll(false);
    });
  });

  [...document.querySelectorAll("[data-copy]")].forEach(btn=>{
    btn.addEventListener("click", async ()=>{
      const id = btn.getAttribute("data-copy");
      const svc = allServices().find(x=>x.id===id);
      if(!svc) return;

      const firstLink = (svc.links && svc.links[0]) ? svc.links[0].url : "";
      const text = [
        svc.name,
        svc.desc || "",
        svc.phone ? ("Call: " + svc.phone) : "",
        svc.email ? ("Email: " + svc.email) : "",
        firstLink
      ].filter(Boolean).join("\n");

      try{
        await navigator.clipboard.writeText(text);
        toast("Copied");
      }catch{
        toast("Copy not supported");
      }
    });
  });
}

function renderAll(rerenderCats=true){
  if(rerenderCats) renderCats();
  renderHeader();
  renderCards();
}

/* -------------------------
   UI actions
   ------------------------- */
$("q").addEventListener("input", ()=>{
  state.q = $("q").value;
  renderAll(false);
});

$("favToggle").addEventListener("click", ()=>{
  state.showFavs = !state.showFavs;
  renderAll(false);
});

$("resetBtn").addEventListener("click", ()=>{
  state.q=""; $("q").value="";
  state.category="All";
  state.showFavs=false;
  renderAll(true);
});

$("nearMeBtn").addEventListener("click", ()=>{
  if(!navigator.geolocation){ toast("Geolocation not supported"); return; }
  toast("Getting location‚Ä¶");
  navigator.geolocation.getCurrentPosition(
    (pos)=>{
      const { latitude, longitude } = pos.coords;
      const url = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent("car park")}&center=${latitude},${longitude}`;
      window.open(url, "_blank");
    },
    ()=> toast("Location blocked in browser settings"),
    { enableHighAccuracy:true, timeout: 10000 }
  );
});

/* -------------------------
   LIVE parking fetch (OpenData)
   ------------------------- */
async function loadLiveSpaces(){
  try{
    $("liveStatus").textContent = "LIVE‚Ä¶";
    $("liveStatus").className = "badge liveWait";

    const res = await fetch("https://api.opendata.je/v1/carparks/spaces?includeCarparkInfo=true", { cache:"no-store" });
    if(!res.ok) throw new Error("Bad response");
    const data = await res.json();
    const results = (data && data.results) ? data.results : [];

    // Create a name->record map
    const list = results.map(r => ({...r, _key: String(r.name||"").toLowerCase()}));

    LIVE_SPACES = LIVE_FALLBACK.map(fb=>{
      const key = fb.name.toLowerCase();
      const r = list.find(x => x._key.includes(key)) || null;
      return {
        ...fb,
        spaces: r ? r.spaces : "‚Äî",
        open: r ? !!r.open : true,
        status: r ? (r.status || "LIVE") : "LIVE"
      };
    });

    $("liveStatus").textContent = "LIVE ‚úì";
    $("liveStatus").className = "badge liveOk";
    renderAll(true);
  }catch(e){
    $("liveStatus").textContent = "LIVE ‚úï";
    $("liveStatus").className = "badge liveBad";
    // Keep fallback list; just re-render
    console.log("Live parking failed:", e);
    renderAll(true);
  }
}

loadLiveSpaces();
setInterval(loadLiveSpaces, 120000);

/* -------------------------
   Service worker
   ------------------------- */
if("serviceWorker" in navigator){
  window.addEventListener("load", ()=>{
    navigator.serviceWorker.register("./sw.js").catch(()=>{});
  });
}

renderAll(true);
</script>
</body>
</html>
