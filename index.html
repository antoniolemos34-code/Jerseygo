<!doctype html>
<html lang="en-GB">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0B1220" />
  <meta name="description" content="JerseyGo ‚Äî Parking LIVE, pharmacies, activities, ports & airport, buses & taxis, emergency." />

  <title>JerseyGo</title>

  <link rel="manifest" href="./manifest.webmanifest" />
  <link rel="icon" href="./icon.svg" type="image/svg+xml">
  <link rel="apple-touch-icon" href="./icon.svg">

  <style>
    :root{
      --bg:#070A12;
      --bg2:#0B1220;
      --card:rgba(255,255,255,.04);
      --line:rgba(255,255,255,.10);
      --text:#E9EEF7;
      --muted:#A9B4C7;
      --accent:#4DA3FF;
      --good:#35D07F;
      --warn:#FFB020;
      --danger:#FF4D5E;
      --r2:22px;
      --shadow: 0 22px 50px rgba(0,0,0,.45);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color:var(--text);
      background:
        radial-gradient(900px 600px at 12% 12%, rgba(77,163,255,.22), transparent 58%),
        radial-gradient(850px 520px at 88% 10%, rgba(53,208,127,.18), transparent 58%),
        radial-gradient(920px 720px at 50% 95%, rgba(255,176,32,.12), transparent 58%),
        linear-gradient(180deg, var(--bg), var(--bg2));
      -webkit-font-smoothing:antialiased;
      text-rendering:optimizeLegibility;
    }
    a{color:inherit; text-decoration:none}
    button{font-family:inherit}
    .wrap{max-width:1180px; margin:0 auto; padding:14px}

    header{
      position:sticky; top:0; z-index:50;
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      background: rgba(7,10,18,.72);
      border-bottom:1px solid var(--line);
    }
    .top{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; flex-wrap:wrap;
      padding:14px;
    }
    .brand{display:flex; align-items:center; gap:12px; min-width:260px}
    .brand img{width:40px; height:40px; border-radius:14px; box-shadow: 0 12px 30px rgba(0,0,0,.35)}
    .brand .t{line-height:1.05}
    .brand .t .name{font-weight:950; font-size:18px}
    .brand .t .sub{margin-top:4px; font-size:12px; color:var(--muted)}
    .actionsTop{display:flex; align-items:center; gap:10px; flex-wrap:wrap; justify-content:flex-end; width:100%}
    @media (min-width: 760px){ .actionsTop{width:auto} }

    .search{
      display:flex; align-items:center; gap:10px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      padding:12px 14px;
      border-radius:999px;
      width:min(94vw, 560px);
    }
    .search input{
      width:100%;
      border:none; outline:none; background:transparent;
      color:var(--text);
      font-size:14px;
    }

    .btn{
      border:1px solid var(--line);
      background: rgba(255,255,255,.05);
      color:var(--text);
      padding:12px 14px;
      border-radius:16px;
      cursor:pointer;
      font-weight:900;
      letter-spacing:.2px;
    }
    .btn:hover{background: rgba(255,255,255,.08)}
    .btn.primary{border-color: rgba(77,163,255,.35); background: rgba(77,163,255,.14)}
    .btn.good{border-color: rgba(53,208,127,.35); background: rgba(53,208,127,.12)}
    .btn.ghost{background: rgba(255,255,255,.03)}

    .grid{
      display:grid;
      grid-template-columns: 330px 1fr;
      gap:14px;
    }
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }

    .panel{
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      border-radius: var(--r2);
      overflow:hidden;
      box-shadow: var(--shadow);
    }

    .panelHd{
      padding:14px 14px;
      display:flex; align-items:center; justify-content:space-between;
      border-bottom:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
    }
    .panelHd h2{
      margin:0;
      font-size:12px;
      color:var(--muted);
      font-weight:950;
      letter-spacing:.35px;
      text-transform:uppercase;
    }
    .badge{
      font-size:12px;
      color:var(--muted);
      border:1px solid var(--line);
      padding:5px 10px;
      border-radius:999px;
      background: rgba(255,255,255,.02);
    }
    .badge.liveOk{border-color: rgba(53,208,127,.35); color: rgba(233,238,247,.95); background: rgba(53,208,127,.10)}
    .badge.liveBad{border-color: rgba(255,77,94,.35); color: rgba(233,238,247,.95); background: rgba(255,77,94,.10)}
    .badge.liveWait{border-color: rgba(255,176,32,.35); color: rgba(233,238,247,.95); background: rgba(255,176,32,.10)}

    .cats{padding:10px}
    .cat{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
      padding:12px 12px;
      border-radius:16px;
      cursor:pointer;
      border:1px solid transparent;
    }
    .cat:hover{background: rgba(255,255,255,.04)}
    .cat.active{
      background: rgba(77,163,255,.10);
      border-color: rgba(77,163,255,.35);
    }
    .catLeft{display:flex; align-items:center; gap:10px}
    .catIcon{
      width:28px; height:28px;
      display:grid; place-items:center;
      border:1px solid var(--line);
      border-radius:10px;
      background: rgba(255,255,255,.03);
    }
    .catName{font-weight:950}
    .catCount{min-width:34px; text-align:center}

    .content{padding:14px}
    .hero{
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border-radius: var(--r2);
      padding:14px;
      display:flex; align-items:flex-start; justify-content:space-between; gap:14px; flex-wrap:wrap;
    }
    .hero h1{margin:0; font-size:20px}
    .hero p{margin:7px 0 0; color:var(--muted); line-height:1.35}
    .mini{font-size:12px; color:var(--muted); margin-top:10px}

    .quick{display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end}
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      padding:10px 12px;
      border-radius:16px;
      font-size:13px;
      cursor:pointer;
      user-select:none;
    }
    .chip:hover{background: rgba(255,255,255,.08)}
    .chip.primary{border-color: rgba(77,163,255,.35); background: rgba(77,163,255,.12)}
    .chip.good{border-color: rgba(53,208,127,.35); background: rgba(53,208,127,.10)}

    .cards{
      margin-top:12px;
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap:12px;
    }
    @media (max-width: 820px){ .cards{grid-template-columns:1fr} }

    .card{
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      border-radius: var(--r2);
      padding:14px;
      display:flex; flex-direction:column; gap:10px;
    }
    .row{display:flex; align-items:flex-start; justify-content:space-between; gap:10px}
    .name{font-weight:950; letter-spacing:.2px}
    .meta{font-size:12px; color:var(--muted); line-height:1.35}
    .tags{display:flex; gap:8px; flex-wrap:wrap}
    .tag{
      font-size:12px;
      border:1px solid var(--line);
      padding:6px 10px;
      border-radius:999px;
      color:var(--muted);
      background: rgba(255,255,255,.02);
    }
    .actions{display:flex; gap:8px; flex-wrap:wrap; margin-top:auto}

    .favBtn{
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
      font-weight:950;
    }
    .favBtn.on{border-color: rgba(77,163,255,.35); background: rgba(77,163,255,.14)}
    .favBtn:hover{background: rgba(255,255,255,.08)}

    .pill{
      font-size:12px;
      font-weight:950;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.02);
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .pill.good{border-color: rgba(53,208,127,.35); background: rgba(53,208,127,.10); color: rgba(233,238,247,.95);}
    .pill.warn{border-color: rgba(255,176,32,.35); background: rgba(255,176,32,.10); color: rgba(233,238,247,.95);}
    .pill.bad{border-color: rgba(255,77,94,.35); background: rgba(255,77,94,.10); color: rgba(233,238,247,.95);}

    .toast{
      position:fixed; left:50%; bottom:16px; transform:translateX(-50%);
      background: rgba(14,22,41,.92);
      border:1px solid var(--line);
      padding:10px 12px;
      border-radius:14px;
      color:var(--text);
      display:none;
      max-width: min(92vw, 560px);
      box-shadow: 0 18px 45px rgba(0,0,0,.45);
      z-index:200;
    }
    .toast.show{display:block}

    footer{
      color:rgba(169,180,199,.8);
      font-size:12px;
      text-align:center;
      padding:14px 0 2px;
    }
  </style>
</head>

<body>
<header>
  <div class="wrap top">
    <div class="brand">
      <img src="./icon.svg" alt="JerseyGo icon">
      <div class="t">
        <div class="name">JerseyGo</div>
        <div class="sub">Parking LIVE ‚Ä¢ Pharmacies ‚Ä¢ Activities ‚Ä¢ Ports & Airport ‚Ä¢ Bus & Taxis ‚Ä¢ Emergency</div>
      </div>
    </div>

    <div class="actionsTop">
      <div class="search">
        <span style="opacity:.9">üîé</span>
        <input id="q" placeholder="Search: spaces, pharmacy, taxi, airport, harbour‚Ä¶" autocomplete="off" />
      </div>
      <button id="favToggle" class="btn good">‚òÖ Favourites</button>
      <button id="nearMeBtn" class="btn primary">üìç Near me</button>
      <button id="resetBtn" class="btn ghost">Reset</button>
    </div>
  </div>
</header>

<div class="wrap grid">
  <aside class="panel">
    <div class="panelHd">
      <h2>Categories</h2>
      <span id="countVisible" class="badge">0</span>
    </div>
    <div id="cats" class="cats"></div>

    <div class="panelHd" style="border-top:1px solid var(--line);">
      <h2>Live status</h2>
      <span id="liveStatus" class="badge liveWait">LIVE‚Ä¶</span>
    </div>
    <div style="padding:12px 14px; color:var(--muted); font-size:12px; line-height:1.45;">
      Live parking spaces update automatically (OpenData). If ‚ÄúLIVE ‚úï‚Äù appears, the app still works (fallback list).
    </div>
  </aside>

  <main class="panel">
    <div class="content">
      <div class="hero">
        <div>
          <h1 id="viewTitle">All services</h1>
          <p id="viewDesc">One-tap actions: Call ‚Ä¢ Email ‚Ä¢ Maps ‚Ä¢ Official pages.</p>
          <div id="statsLine" class="mini">Loading‚Ä¶</div>
        </div>

        <div class="quick">
          <a class="chip primary" href="https://www.gov.je/Travel/Motoring/Parking/pages/carparkspaces.aspx" target="_blank" rel="noopener">üÖøÔ∏è Official Live</a>
          <a class="chip" href="https://www.gov.je/Health/DoctorDentist/PharmacistsChemists/pages/pharmacyopeninghours.aspx" target="_blank" rel="noopener">üíä Pharmacy hours</a>
          <a class="chip" href="https://www.ports.je/about-us/contact/" target="_blank" rel="noopener">‚öì Ports contact</a>
          <a class="chip" href="https://www.jersey.com/things-to-do/" target="_blank" rel="noopener">‚ú® Things to do</a>
        </div>
      </div>

      <div id="cards" class="cards"></div>

      <footer>
        Emergency: call <b>999</b> / <b>112</b> ‚Ä¢ JerseyGo (unofficial directory; public sources)
      </footer>
    </div>
  </main>
</div>

<div id="toast" class="toast"></div>

<script>
/* =========================================================
   JerseyGo ‚Äî PWA directory + Parking LIVE
   ========================================================= */
const $ = (id)=>document.getElementById(id);
const norm = (s)=> (s||"").toLowerCase().trim();
const escapeHtml = (s)=> (s||"")
  .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
  .replaceAll('"',"&quot;").replaceAll("'","&#039;");

const toast = (msg)=>{
  const t = $("toast");
  t.textContent = msg;
  t.classList.add("show");
  clearTimeout(window.__toast);
  window.__toast = setTimeout(()=>t.classList.remove("show"), 1600);
};

const telHref = (phone)=>{
  const cleaned = (phone||"").replace(/[^\d+]/g,"");
  return cleaned ? ("tel:" + cleaned) : "#";
};
const mailHref = (email)=> email ? ("mailto:" + email) : "#";
const mapsUrl = (query)=> `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(query || "Jersey")}`;

const CATEGORY_ORDER = [
  "Emergency",
  "Parking LIVE",
  "Pharmacies",
  "Activities",
  "Ports & Airport",
  "Bus & Taxis"
];

const LS_FAVS = "jerseygo:favs:v2";

const state = {
  q: "",
  category: "All",
  showFavs: false,
  favs: new Set(JSON.parse(localStorage.getItem(LS_FAVS) || "[]"))
};

function catIcon(cat){
  switch(cat){
    case "All": return "üß≠";
    case "Emergency": return "üö®";
    case "Parking LIVE": return "üÖøÔ∏è";
    case "Pharmacies": return "üíä";
    case "Activities": return "‚ú®";
    case "Ports & Airport": return "‚úàÔ∏è";
    case "Bus & Taxis": return "üöå";
    default: return "‚Ä¢";
  }
}

/* -------------------------
   SOURCES / LINKS (public)
   ------------------------- */
const LINKS = {
  parkingOfficialLive: "https://www.gov.je/Travel/Motoring/Parking/pages/carparkspaces.aspx",
  portsContact: "https://www.ports.je/about-us/contact/",
  jerseyAirportContact: "https://www.jerseyairport.com/contact/contact-us/",
  jerseyHarboursContact: "https://www.gov.je/pages/contacts.aspx?contactId=40",
  libertyBusContactGov: "https://www.gov.je/pages/contacts.aspx?contactId=187",
  busRoutesGov: "https://www.gov.je/Travel/Buses/Pages/RoutesTimetables.aspx",
  pharmacyHoursGov: "https://www.gov.je/Health/DoctorDentist/PharmacistsChemists/pages/pharmacyopeninghours.aspx",
  hospitalPharmacyContactGov: "https://www.gov.je/pages/contacts.aspx?contactId=116",
  hospitalPharmacyInfoGov: "https://www.gov.je/Health/DoctorDentist/PharmacistsChemists/pages/hospitalpharmacy.aspx",
  emergencyGov: "https://www.gov.je/LifeEvents/MovingToJersey/WhenYouArrive/pages/contactemergencyservices.aspx",
  policeContact: "https://www.jersey.police.je/s/contact-us",
  thingsToDo: "https://www.jersey.com/things-to-do/",
  activitiesListings: "https://www.jersey.com/things-to-do/activities/listings/",
  events: "https://www.jersey.com/things-to-do/events/",
  taxisInfoVisitJersey: "https://www.jersey.com/plan-your-break/getting-around-jersey/public-transport-taxis/",
  taxiRanksJTDA: "https://www.jerseytaxidriversassociation.co/taxi-ranks--maps.html",
  taxiNumbersFOI: "https://www.gov.je/Freedom%20of%20Information%20library/ID%20FOI%20Jersey%20Taxicabs%20and%20Associations%20June%202018%2020180705.pdf"
};

/* -------------------------
   DIRECTORY (static items)
   ------------------------- */
const DIRECTORY_STATIC = [
  // Emergency
  {
    id:"emg-999",
    category:"Emergency",
    name:"Emergency services (999 / 112)",
    desc:"Ambulance, Police, Fire. Use 999 or 112 for emergencies.",
    tags:["999","112","emergency"],
    phone:"999",
    links:[
      {label:"Official info (gov.je)", url: LINKS.emergencyGov},
      {label:"999 guidance (gov.je)", url: "https://www.gov.je/Health/Hospitals/EmergencyOutHours/pages/999.aspx"}
    ],
    mapsQuery:"Jersey General Hospital Emergency Department"
  },
  {
    id:"emg-police-nonemg",
    category:"Emergency",
    name:"Police (non-emergency)",
    desc:"Report non-emergency crime / advice.",
    tags:["police","non emergency"],
    phone:"+44 1534 612612",
    links:[
      {label:"Police contact", url: LINKS.policeContact},
      {label:"Official guidance (gov.je)", url: LINKS.emergencyGov}
    ],
    mapsQuery:"Police Headquarters St Helier Jersey"
  },
  {
    id:"emg-coastguard",
    category:"Emergency",
    name:"Jersey Coastguard (non-emergency contact)",
    desc:"Sea safety. For emergencies dial 999 and ask for Coastguard.",
    tags:["coastguard","sea"],
    phone:"01534 447705",
    links:[
      {label:"Ports contact page", url: LINKS.portsContact}
    ],
    mapsQuery:"Maritime House St Helier Jersey"
  },

  // Pharmacies
  {
    id:"pharm-hours",
    category:"Pharmacies",
    name:"Pharmacy opening hours (official list)",
    desc:"Search opening hours by pharmacy.",
    tags:["opening hours","official"],
    links:[{label:"gov.je", url: LINKS.pharmacyHoursGov}],
    mapsQuery:"Pharmacy St Helier Jersey"
  },
  {
    id:"pharm-hospital",
    category:"Pharmacies",
    name:"General Hospital Pharmacy",
    desc:"Contact + opening hours (weekdays).",
    tags:["hospital pharmacy"],
    phone:"01534 442627",
    links:[
      {label:"Contact (gov.je)", url: LINKS.hospitalPharmacyContactGov},
      {label:"Medicines helpline (gov.je)", url: LINKS.hospitalPharmacyInfoGov}
    ],
    mapsQuery:"General Hospital Pharmacy Jersey"
  },
  {
    id:"pharm-meds-helpline",
    category:"Pharmacies",
    name:"Medicines Helpline (advice)",
    desc:"Confidential medicines advice (not for emergencies).",
    tags:["medicines","advice"],
    phone:"+44 1534 442605",
    links:[{label:"Info (gov.je)", url: LINKS.hospitalPharmacyInfoGov}],
    mapsQuery:"General Hospital Jersey"
  },

  // Activities
  {
    id:"act-things",
    category:"Activities",
    name:"Things to do in Jersey",
    desc:"Top experiences and attractions (official tourism site).",
    tags:["visit","things to do"],
    links:[{label:"jersey.com", url: LINKS.thingsToDo}],
    mapsQuery:"Jersey attractions"
  },
  {
    id:"act-activities",
    category:"Activities",
    name:"Activities listings (all)",
    desc:"Browse activities: sea sports, tours, museums, etc.",
    tags:["activities","listings"],
    links:[{label:"Listings", url: LINKS.activitiesListings}],
    mapsQuery:"Jersey activities"
  },
  {
    id:"act-events",
    category:"Activities",
    name:"Events (what‚Äôs on)",
    desc:"Upcoming events and festivals.",
    tags:["events","what's on"],
    links:[{label:"Events", url: LINKS.events}],
    mapsQuery:"St Helier events"
  },

  // Ports & Airport
  {
    id:"port-contact",
    category:"Ports & Airport",
    name:"Ports of Jersey (Airport & Harbours)",
    desc:"General enquiries + customer relations.",
    tags:["ports","airport","harbour"],
    phone:"+44 1534 446000",
    email:"customerrelations@ports.je",
    links:[{label:"Contact (ports.je)", url: LINKS.portsContact}],
    mapsQuery:"Ports of Jersey St Peter JE1 1BY"
  },
  {
    id:"port-harbours",
    category:"Ports & Airport",
    name:"Jersey Harbours (contact)",
    desc:"Harbours office contact + email.",
    tags:["harbours","ferry terminal"],
    phone:"01534 447788",
    email:"jerseyharbours@ports.je",
    links:[
      {label:"Contact (gov.je)", url: LINKS.jerseyHarboursContact},
      {label:"Ports website", url: "https://www.ports.je/"}
    ],
    mapsQuery:"Maritime House La Route du Port Elizabeth St Helier"
  },
  {
    id:"port-airport",
    category:"Ports & Airport",
    name:"Jersey Airport (contact)",
    desc:"Airport enquiries + info email.",
    tags:["airport"],
    phone:"01534 446000",
    email:"airportInformation@ports.je",
    links:[
      {label:"Airport contact", url: LINKS.jerseyAirportContact},
      {label:"Airport website", url: "https://www.jerseyairport.com/"}
    ],
    mapsQuery:"Jersey Airport"
  },

  // Bus & Taxis
  {
    id:"bus-liberty",
    category:"Bus & Taxis",
    name:"LibertyBus (contact)",
    desc:"Bus routes, timetables, tickets.",
    tags:["bus","timetable"],
    phone:"01534 828555",
    email:"info@libertybus.je",
    links:[
      {label:"Website", url:"https://libertybus.je/"},
      {label:"Contact (gov.je)", url: LINKS.libertyBusContactGov},
      {label:"Routes & timetables (gov.je)", url: LINKS.busRoutesGov}
    ],
    mapsQuery:"Liberation Station St Helier JE1 3AS"
  },
  {
    id:"taxi-info",
    category:"Bus & Taxis",
    name:"Taxis in Jersey (info)",
    desc:"Taxi ranks, fares, general guidance.",
    tags:["taxis","fares"],
    links:[{label:"Visit Jersey (taxis)", url: LINKS.taxisInfoVisitJersey}],
    mapsQuery:"Taxi rank St Helier"
  },
  {
    id:"taxi-ranks",
    category:"Bus & Taxis",
    name:"Taxi ranks & maps (JTDA)",
    desc:"Rank locations (airport, harbour, town).",
    tags:["taxi ranks","maps"],
    links:[{label:"JTDA ranks", url: LINKS.taxiRanksJTDA}],
    mapsQuery:"Taxi rank Jersey Airport"
  },
  {
    id:"taxi-libertycabs",
    category:"Bus & Taxis",
    name:"Liberty Cabs (booked taxis)",
    desc:"Popular taxi booking number (verify if changed).",
    tags:["taxi","book"],
    phone:"01534 767700",
    links:[{label:"Numbers source (gov.je PDF)", url: LINKS.taxiNumbersFOI}],
    mapsQuery:"27 Lewis Street St Helier Jersey"
  },
  {
    id:"taxi-yellowcabs",
    category:"Bus & Taxis",
    name:"Yellow Cabs (booked taxis)",
    desc:"Popular taxi booking number (verify if changed).",
    tags:["taxi","book"],
    phone:"01534 888888",
    links:[{label:"Numbers source (gov.je PDF)", url: LINKS.taxiNumbersFOI}],
    mapsQuery:"St Helier Jersey"
  }
];

/* -------------------------
   Parking LIVE (OpenData + per car park)
   ------------------------- */
const LIVE_FALLBACK = [
  { code:"charles", name:"Charles Street", mapsQuery:"Charles Street car park St Helier Jersey" },
  { code:"green", name:"Green Street", mapsQuery:"Green Street car park St Helier Jersey" },
  { code:"lesjardin", name:"Les Jardin", mapsQuery:"Les Jardin car park St Helier Jersey" },
  { code:"minden", name:"Minden Place", mapsQuery:"Minden Place car park St Helier Jersey" },
  { code:"patriotic", name:"Patriotic Street", mapsQuery:"Patriotic Street car park St Helier Jersey" },
  { code:"pier", name:"Pier Road", mapsQuery:"Pier Road car park St Helier Jersey" },
  { code:"sand", name:"Sand Street", mapsQuery:"Sand Street car park St Helier Jersey" }
];

let LIVE_SPACES = LIVE_FALLBACK.map(x => ({...x, spaces:"‚Äî", open:true, status:"LIVE"}));

function spacesNum(x){
  const n = Number(String(x.spaces).replace(/[^\d]/g,""));
  return Number.isFinite(n) ? n : -1;
}
function spacesBadgeHTML(n){
  if(n < 0) return `<span class="pill">Spaces: ‚Äî</span>`;
  if(n >= 200) return `<span class="pill good">Spaces: ${n}</span>`;
  if(n >= 80)  return `<span class="pill warn">Spaces: ${n}</span>`;
  return `<span class="pill bad">Spaces: ${n}</span>`;
}

function buildLiveParkingServices(){
  const sorted = [...LIVE_SPACES].sort((a,b)=> spacesNum(b) - spacesNum(a));
  return sorted.map(x => {
    const n = spacesNum(x);
    return ({
      id: "live-" + x.code,
      category: "Parking LIVE",
      name: `LIVE: ${x.name}`,
      desc: `${x.open ? "Open" : "Closed"} ‚Ä¢ Spaces available: ${x.spaces}`,
      tags: ["live spaces","multi-storey", (n>=0 ? `spaces:${n}` : "spaces:unknown")],
      pillHTML: spacesBadgeHTML(n),
      links: [
        { label:"Official Live (gov.je)", url: LINKS.parkingOfficialLive },
        { label:"PayByPhone info", url: "https://www.gov.je/Travel/Motoring/Parking/PayForParking/pages/paybyphoneapp.aspx" }
      ],
      mapsQuery: x.mapsQuery
    });
  });
}

/* -------------------------
   Build all services
   ------------------------- */
function allServices(){
  return [
    ...buildLiveParkingServices(),
    ...DIRECTORY_STATIC
  ];
}

/* -------------------------
   Filter/search
   ------------------------- */
function matchesQuery(svc, q){
  if(!q) return true;
  const hay = [
    svc.name, svc.desc, svc.category,
    ...(svc.tags||[]),
    svc.phone||"",
    svc.email||"",
    ...(svc.links||[]).map(x=>x.label+" "+x.url),
    svc.mapsQuery||""
  ].join(" ");
  return norm(hay).includes(norm(q));
}

function visibleServices(){
  return allServices()
    .filter(s => state.category === "All" ? true : s.category === state.category)
    .filter(s => state.showFavs ? state.favs.has(s.id) : true)
    .filter(s => matchesQuery(s, state.q));
}

/* -------------------------
   Render
   ------------------------- */
function renderCats(){
  const merged = allServices();
  const counts = merged.reduce((acc, s)=>{ acc[s.category]=(acc[s.category]||0)+1; return acc; },{});
  const cats = ["All", ...CATEGORY_ORDER.filter(c => counts[c])];

  $("cats").innerHTML = cats.map(cat=>{
    const count = cat==="All" ? merged.length : (counts[cat]||0);
    const active = (state.category===cat) ? "active" : "";
    return `
      <div class="cat ${active}" data-cat="${escapeHtml(cat)}">
        <div class="catLeft">
          <div class="catIcon">${catIcon(cat)}</div>
          <div class="catName">${escapeHtml(cat)}</div>
        </div>
        <div class="badge catCount">${count}</div>
      </div>
    `;
  }).join("");

  [...document.querySelectorAll(".cat[data-cat]")].forEach(el=>{
    el.addEventListener("click", ()=>{
      state.category = el.getAttribute("data-cat");
      renderAll(false);
    });
  });
}

function renderHeader(){
  const list = visibleServices();
  const title = (state.category==="All") ? "All services" : state.category;
  $("viewTitle").textContent = `${title} (${list.length})`;

  if(state.category === "Parking LIVE"){
    $("viewDesc").textContent = "Live multi-storey spaces (sorted) + official links.";
  } else if(state.category === "Emergency"){
    $("viewDesc").textContent = "Emergency numbers + official pages. In danger, call 999/112.";
  } else if(state.category === "Pharmacies"){
    $("viewDesc").textContent = "Pharmacy opening hours + hospital pharmacy contacts.";
  } else if(state.category === "Ports & Airport"){
    $("viewDesc").textContent = "Ports, harbours and airport contacts + maps.";
  } else if(state.category === "Bus & Taxis"){
    $("viewDesc").textContent = "LibertyBus + taxi info/ranks + booking numbers.";
  } else if(state.category === "Activities"){
    $("viewDesc").textContent = "Things to do + activities + events.";
  } else if(state.showFavs){
    $("viewDesc").textContent = "Your saved services for one-tap access.";
  } else {
    $("viewDesc").textContent = "One-tap actions: Call ‚Ä¢ Email ‚Ä¢ Maps ‚Ä¢ Official pages.";
  }

  $("statsLine").textContent = `Showing ${list.length} ‚Ä¢ Live spaces refresh every ~2 minutes`;
  $("countVisible").textContent = list.length;
}

function renderCards(){
  const list = visibleServices();
  const el = $("cards");

  if(!list.length){
    el.innerHTML = `
      <div class="card" style="grid-column:1/-1;">
        <div class="name">No results</div>
        <div class="meta">Try: ‚Äúspaces‚Äù, ‚Äúpharmacy‚Äù, ‚Äútaxi‚Äù, ‚Äúairport‚Äù, ‚Äúports‚Äù.</div>
      </div>
    `;
    return;
  }

  el.innerHTML = list.map(s=>{
    const isFav = state.favs.has(s.id);
    const tags = (s.tags||[]).slice(0,10).map(t=>`<span class="tag">${escapeHtml(String(t))}</span>`).join("");

    const phoneBtn = s.phone ? `<a class="chip" href="${telHref(s.phone)}">üìû Call</a>` : "";
    const emailBtn = s.email ? `<a class="chip" href="${mailHref(s.email)}">‚úâÔ∏è Email</a>` : "";
    const mapsBtn = `<a class="chip" href="${mapsUrl(s.mapsQuery || (s.name + " Jersey"))}" target="_blank" rel="noopener">üó∫Ô∏è Maps</a>`;
    const links = (s.links||[]).slice(0,3).map(l=>`<a class="chip primary" href="${l.url}" target="_blank" rel="noopener">‚Üó ${escapeHtml(l.label)}</a>`).join("");

    const pill = s.pillHTML ? `<div style="margin-top:6px;">${s.pillHTML}</div>` : "";

    return `
      <div class="card">
        <div class="row">
          <div>
            <div class="name">${escapeHtml(s.name)}</div>
            <div class="meta">${escapeHtml(s.desc || "")}</div>
            ${pill}
          </div>
          <button class="favBtn ${isFav ? "on" : ""}" data-fav="${escapeHtml(s.id)}">${isFav ? "‚òÖ" : "‚òÜ"}</button>
        </div>

        <div class="tags">${tags}</div>

        <div class="actions">
          ${phoneBtn}
          ${emailBtn}
          ${mapsBtn}
          ${links}
          <button class="chip" type="button" data-copy="${escapeHtml(s.id)}">üìã Copy</button>
        </div>
      </div>
    `;
  }).join("");

  [...document.querySelectorAll("[data-fav]")].forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const id = btn.getAttribute("data-fav");
      if(state.favs.has(id)){
        state.favs.delete(id);
        toast("Removed from favourites");
      }else{
        state.favs.add(id);
        toast("Saved to favourites");
      }
      localStorage.setItem(LS_FAVS, JSON.stringify([...state.favs]));
      renderAll(false);
    });
  });

  [...document.querySelectorAll("[data-copy]")].forEach(btn=>{
    btn.addEventListener("click", async ()=>{
      const id = btn.getAttribute("data-copy");
      const svc = allServices().find(x=>x.id===id);
      if(!svc) return;

      const firstLink = (svc.links && svc.links[0]) ? svc.links[0].url : "";
      const text = [
        svc.name,
        svc.desc || "",
        svc.phone ? ("Call: " + svc.phone) : "",
        svc.email ? ("Email: " + svc.email) : "",
        firstLink
      ].filter(Boolean).join("\n");

      try{
        await navigator.clipboard.writeText(text);
        toast("Copied");
      }catch{
        toast("Copy not supported");
      }
    });
  });
}

function renderAll(rerenderCats=true){
  if(rerenderCats) renderCats();
  renderHeader();
  renderCards();
}

/* -------------------------
   UI actions
   ------------------------- */
$("q").addEventListener("input", ()=>{
  state.q = $("q").value;
  renderAll(false);
});

$("favToggle").addEventListener("click", ()=>{
  state.showFavs = !state.showFavs;
  renderAll(false);
});

$("resetBtn").addEventListener("click", ()=>{
  state.q=""; $("q").value="";
  state.category="All";
  state.showFavs=false;
  renderAll(true);
});

$("nearMeBtn").addEventListener("click", ()=>{
  if(!navigator.geolocation){ toast("Geolocation not supported"); return; }
  toast("Getting location‚Ä¶");
  navigator.geolocation.getCurrentPosition(
    (pos)=>{
      const { latitude, longitude } = pos.coords;
      const url = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent("services")}&center=${latitude},${longitude}`;
      window.open(url, "_blank");
    },
    ()=> toast("Location blocked in browser settings"),
    { enableHighAccuracy:true, timeout: 10000 }
  );
});

/* -------------------------
   LIVE parking fetch (OpenData)
   ------------------------- */
async function loadLiveSpaces(){
  try{
    $("liveStatus").textContent = "LIVE‚Ä¶";
    $("liveStatus").className = "badge liveWait";

    const res = await fetch("https://api.opendata.je/v1/carparks/spaces?includeCarparkInfo=true", { cache:"no-store" });
    if(!res.ok) throw new Error("Bad response");
    const data = await res.json();
    const results = (data && data.results) ? data.results : [];

    const list = results.map(r => ({...r, _key: String(r.name||"").toLowerCase()}));

    LIVE_SPACES = LIVE_FALLBACK.map(fb=>{
      const key = fb.name.toLowerCase();
      const r = list.find(x => x._key.includes(key)) || null;
      return {
        ...fb,
        spaces: r ? r.spaces : "‚Äî",
        open: r ? !!r.open : true,
        status: r ? (r.status || "LIVE") : "LIVE"
      };
    });

    $("liveStatus").textContent = "LIVE ‚úì";
    $("liveStatus").className = "badge liveOk";
    renderAll(true);
  }catch(e){
    $("liveStatus").textContent = "LIVE ‚úï";
    $("liveStatus").className = "badge liveBad";
    console.log("Live parking failed:", e);
    renderAll(true);
  }
}

loadLiveSpaces();
setInterval(loadLiveSpaces, 120000);

/* -------------------------
   Service worker
   ------------------------- */
if("serviceWorker" in navigator){
  window.addEventListener("load", ()=>{
    navigator.serviceWorker.register("./sw.js").catch(()=>{});
  });
}

renderAll(true);
</script>
</body>
</html>
