<!doctype html>
<html lang="en-GB">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0B1220" />
  <meta name="description" content="JerseyGo ‚Äî Parking LIVE, museums, activities, ports & airport, buses & taxis, pharmacies, emergency." />

  <title>JerseyGo</title>

  <link rel="manifest" href="./manifest.webmanifest" />
  <link rel="icon" href="./icon.svg" type="image/svg+xml">
  <link rel="apple-touch-icon" href="./icon.svg">

  <style>
    :root{
      --bg:#070A12;
      --bg2:#0B1220;
      --card:rgba(255,255,255,.04);
      --line:rgba(255,255,255,.10);
      --text:#E9EEF7;
      --muted:#A9B4C7;
      --accent:#4DA3FF;
      --good:#35D07F;
      --warn:#FFB020;
      --danger:#FF4D5E;
      --r2:22px;
      --shadow: 0 22px 50px rgba(0,0,0,.45);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color:var(--text);
      background:
        radial-gradient(900px 600px at 12% 12%, rgba(77,163,255,.22), transparent 58%),
        radial-gradient(850px 520px at 88% 10%, rgba(53,208,127,.18), transparent 58%),
        radial-gradient(920px 720px at 50% 95%, rgba(255,176,32,.12), transparent 58%),
        linear-gradient(180deg, var(--bg), var(--bg2));
      -webkit-font-smoothing:antialiased;
      text-rendering:optimizeLegibility;
    }
    a{color:inherit; text-decoration:none}
    button{font-family:inherit}
    .wrap{max-width:1180px; margin:0 auto; padding:14px}

    header{
      position:sticky; top:0; z-index:50;
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      background: rgba(7,10,18,.72);
      border-bottom:1px solid var(--line);
    }
    .top{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; flex-wrap:wrap;
      padding:14px;
    }
    .brand{display:flex; align-items:center; gap:12px; min-width:260px}
    .brand img{width:40px; height:40px; border-radius:14px; box-shadow: 0 12px 30px rgba(0,0,0,.35)}
    .brand .t{line-height:1.05}
    .brand .t .name{font-weight:950; font-size:18px}
    .brand .t .sub{margin-top:4px; font-size:12px; color:var(--muted)}
    .actionsTop{display:flex; align-items:center; gap:10px; flex-wrap:wrap; justify-content:flex-end; width:100%}
    @media (min-width: 760px){ .actionsTop{width:auto} }

    .search{
      display:flex; align-items:center; gap:10px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      padding:12px 14px;
      border-radius:999px;
      width:min(94vw, 560px);
    }
    .search input{
      width:100%;
      border:none; outline:none; background:transparent;
      color:var(--text);
      font-size:14px;
    }

    .btn{
      border:1px solid var(--line);
      background: rgba(255,255,255,.05);
      color:var(--text);
      padding:12px 14px;
      border-radius:16px;
      cursor:pointer;
      font-weight:900;
      letter-spacing:.2px;
    }
    .btn:hover{background: rgba(255,255,255,.08)}
    .btn.primary{border-color: rgba(77,163,255,.35); background: rgba(77,163,255,.14)}
    .btn.good{border-color: rgba(53,208,127,.35); background: rgba(53,208,127,.12)}
    .btn.ghost{background: rgba(255,255,255,.03)}

    .grid{
      display:grid;
      grid-template-columns: 330px 1fr;
      gap:14px;
    }
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }

    .panel{
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      border-radius: var(--r2);
      overflow:hidden;
      box-shadow: var(--shadow);
    }

    .panelHd{
      padding:14px 14px;
      display:flex; align-items:center; justify-content:space-between;
      border-bottom:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
    }
    .panelHd h2{
      margin:0;
      font-size:12px;
      color:var(--muted);
      font-weight:950;
      letter-spacing:.35px;
      text-transform:uppercase;
    }
    .badge{
      font-size:12px;
      color:var(--muted);
      border:1px solid var(--line);
      padding:5px 10px;
      border-radius:999px;
      background: rgba(255,255,255,.02);
    }
    .badge.liveOk{border-color: rgba(53,208,127,.35); color: rgba(233,238,247,.95); background: rgba(53,208,127,.10)}
    .badge.liveBad{border-color: rgba(255,77,94,.35); color: rgba(233,238,247,.95); background: rgba(255,77,94,.10)}
    .badge.liveWait{border-color: rgba(255,176,32,.35); color: rgba(233,238,247,.95); background: rgba(255,176,32,.10)}

    .cats{padding:10px}
    .cat{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
      padding:12px 12px;
      border-radius:16px;
      cursor:pointer;
      border:1px solid transparent;
    }
    .cat:hover{background: rgba(255,255,255,.04)}
    .cat.active{
      background: rgba(77,163,255,.10);
      border-color: rgba(77,163,255,.35);
    }
    .catLeft{display:flex; align-items:center; gap:10px}
    .catIcon{
      width:28px; height:28px;
      display:grid; place-items:center;
      border:1px solid var(--line);
      border-radius:10px;
      background: rgba(255,255,255,.03);
    }
    .catName{font-weight:950}
    .catCount{min-width:34px; text-align:center}

    .content{padding:14px}
    .hero{
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border-radius: var(--r2);
      padding:14px;
      display:flex; align-items:flex-start; justify-content:space-between; gap:14px; flex-wrap:wrap;
    }
    .hero h1{margin:0; font-size:20px}
    .hero p{margin:7px 0 0; color:var(--muted); line-height:1.35}
    .mini{font-size:12px; color:var(--muted); margin-top:10px}

    .quick{display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end}
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      padding:10px 12px;
      border-radius:16px;
      font-size:13px;
      cursor:pointer;
      user-select:none;
    }
    .chip:hover{background: rgba(255,255,255,.08)}
    .chip.primary{border-color: rgba(77,163,255,.35); background: rgba(77,163,255,.12)}
    .chip.good{border-color: rgba(53,208,127,.35); background: rgba(53,208,127,.10)}

    .cards{
      margin-top:12px;
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap:12px;
    }
    @media (max-width: 820px){ .cards{grid-template-columns:1fr} }

    .card{
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      border-radius: var(--r2);
      padding:14px;
      display:flex; flex-direction:column; gap:10px;
    }
    .row{display:flex; align-items:flex-start; justify-content:space-between; gap:10px}
    .name{font-weight:950; letter-spacing:.2px}
    .meta{font-size:12px; color:var(--muted); line-height:1.35}
    .tags{display:flex; gap:8px; flex-wrap:wrap}
    .tag{
      font-size:12px;
      border:1px solid var(--line);
      padding:6px 10px;
      border-radius:999px;
      color:var(--muted);
      background: rgba(255,255,255,.02);
    }
    .actions{display:flex; gap:8px; flex-wrap:wrap; margin-top:auto}

    .favBtn{
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
      font-weight:950;
    }
    .favBtn.on{border-color: rgba(77,163,255,.35); background: rgba(77,163,255,.14)}
    .favBtn:hover{background: rgba(255,255,255,.08)}

    .pill{
      font-size:12px;
      font-weight:950;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.02);
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .pill.good{border-color: rgba(53,208,127,.35); background: rgba(53,208,127,.10); color: rgba(233,238,247,.95);}
    .pill.warn{border-color: rgba(255,176,32,.35); background: rgba(255,176,32,.10); color: rgba(233,238,247,.95);}
    .pill.bad{border-color: rgba(255,77,94,.35); background: rgba(255,77,94,.10); color: rgba(233,238,247,.95);}

    .toast{
      position:fixed; left:50%; bottom:16px; transform:translateX(-50%);
      background: rgba(14,22,41,.92);
      border:1px solid var(--line);
      padding:10px 12px;
      border-radius:14px;
      color:var(--text);
      display:none;
      max-width: min(92vw, 560px);
      box-shadow: 0 18px 45px rgba(0,0,0,.45);
      z-index:200;
    }
    .toast.show{display:block}

    footer{
      color:rgba(169,180,199,.8);
      font-size:12px;
      text-align:center;
      padding:14px 0 2px;
    }
  </style>
</head>

<body>
<header>
  <div class="wrap top">
    <div class="brand">
      <img src="./icon.svg" alt="JerseyGo icon">
      <div class="t">
        <div class="name">JerseyGo</div>
        <div class="sub">Parking LIVE ‚Ä¢ Museums ‚Ä¢ Activities ‚Ä¢ Ports & Airport ‚Ä¢ Bus & Taxis ‚Ä¢ Pharmacies ‚Ä¢ Emergency</div>
      </div>
    </div>

    <div class="actionsTop">
      <div class="search">
        <span style="opacity:.9">üîé</span>
        <input id="q" placeholder="Search: spaces, museum, castle, taxi, airport‚Ä¶" autocomplete="off" />
      </div>
      <button id="favToggle" class="btn good">‚òÖ Favourites</button>
      <button id="nearMeBtn" class="btn primary">üìç Near me</button>
      <button id="resetBtn" class="btn ghost">Reset</button>
    </div>
  </div>
</header>

<div class="wrap grid">
  <aside class="panel">
    <div class="panelHd">
      <h2>Categories</h2>
      <span id="countVisible" class="badge">0</span>
    </div>
    <div id="cats" class="cats"></div>

    <div class="panelHd" style="border-top:1px solid var(--line);">
      <h2>Live parking</h2>
      <span id="liveStatus" class="badge liveWait">LIVE‚Ä¶</span>
    </div>
    <div style="padding:12px 14px; color:var(--muted); font-size:12px; line-height:1.45;">
      Parking LIVE uses the official government JSON feed. Auto-refresh ~2 minutes.
    </div>
  </aside>

  <main class="panel">
    <div class="content">
      <div class="hero">
        <div>
          <h1 id="viewTitle">All services</h1>
          <p id="viewDesc">One-tap actions: Call ‚Ä¢ Email ‚Ä¢ Maps ‚Ä¢ Official pages.</p>
          <div id="statsLine" class="mini">Loading‚Ä¶</div>
        </div>

        <div class="quick">
          <a class="chip primary" href="https://www.gov.je/Travel/Motoring/Parking/pages/carparkspaces.aspx" target="_blank" rel="noopener">üÖøÔ∏è Official Live</a>
          <a class="chip" href="https://www.jerseyheritage.org/visit/places-to-visit/" target="_blank" rel="noopener">üèõÔ∏è Museums list</a>
          <a class="chip" href="https://www.jersey.com/things-to-do/attractions/" target="_blank" rel="noopener">‚ú® Attractions</a>
          <a class="chip" href="https://www.jersey.com/things-to-do/events/" target="_blank" rel="noopener">üìÖ Events</a>
        </div>
      </div>

      <div id="cards" class="cards"></div>

      <footer>
        Emergency: call <b>999</b> / <b>112</b> ‚Ä¢ JerseyGo (unofficial directory; uses public sources)
      </footer>
    </div>
  </main>
</div>

<div id="toast" class="toast"></div>

<script>
/* =========================================================
   JerseyGo ‚Äî PWA directory + TRUE Parking LIVE (gov feed)
   ========================================================= */
const $ = (id)=>document.getElementById(id);
const norm = (s)=> (s||"").toLowerCase().trim();
const escapeHtml = (s)=> (s||"")
  .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
  .replaceAll('"',"&quot;").replaceAll("'","&#039;");

const toast = (msg)=>{
  const t = $("toast");
  t.textContent = msg;
  t.classList.add("show");
  clearTimeout(window.__toast);
  window.__toast = setTimeout(()=>t.classList.remove("show"), 1600);
};

const telHref = (phone)=>{
  const cleaned = (phone||"").replace(/[^\d+]/g,"");
  return cleaned ? ("tel:" + cleaned) : "#";
};
const mailHref = (email)=> email ? ("mailto:" + email) : "#";
const mapsUrl = (query)=> `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(query || "Jersey")}`;

const CATEGORY_ORDER = [
  "Emergency",
  "Parking LIVE",
  "Museums & Heritage",
  "Activities",
  "Ports & Airport",
  "Bus & Taxis",
  "Pharmacies"
];

const LS_FAVS = "jerseygo:favs:v3";

const state = {
  q: "",
  category: "All",
  showFavs: false,
  favs: new Set(JSON.parse(localStorage.getItem(LS_FAVS) || "[]"))
};

function catIcon(cat){
  switch(cat){
    case "All": return "üß≠";
    case "Emergency": return "üö®";
    case "Parking LIVE": return "üÖøÔ∏è";
    case "Museums & Heritage": return "üèõÔ∏è";
    case "Activities": return "‚ú®";
    case "Ports & Airport": return "‚úàÔ∏è";
    case "Bus & Taxis": return "üöå";
    case "Pharmacies": return "üíä";
    default: return "‚Ä¢";
  }
}

/* -------------------------
   LINKS (public, official)
   ------------------------- */
const LINKS = {
  govLivePage: "https://www.gov.je/Travel/Motoring/Parking/pages/carparkspaces.aspx",
  payByPhone: "https://www.gov.je/Travel/Motoring/Parking/PayForParking/pages/paybyphoneapp.aspx",

  heritageHome: "https://www.jerseyheritage.org/",
  heritagePlaces: "https://www.jerseyheritage.org/visit/places-to-visit/",
  jerseyMuseum: "https://www.jerseyheritage.org/visit/places-to-visit/jersey-museum/",
  maritimeMuseum: "https://www.jerseyheritage.org/visit/places-to-visit/maritime-museum-occupation-tapestry/",
  hamptonne: "https://www.jerseyheritage.org/visit/places-to-visit/hamptonne-country-life-museum/",
  heritageWhatsOn: "https://www.jerseyheritage.org/visit/whats-on/",

  visitThings: "https://www.jersey.com/things-to-do/",
  visitAttractions: "https://www.jersey.com/things-to-do/attractions/",
  visitEvents: "https://www.jersey.com/things-to-do/events/",
  visitEventsListings: "https://www.jersey.com/things-to-do/events/listings/",

  nationalTrust: "https://www.nationaltrust.je/",
  nationalTrustBuildings: "https://www.nationaltrust.je/our-work/historic-buildings/",
  ntHamptonne: "https://www.nationaltrust.je/our-work/historic-buildings/hamptonne-country-life-museum/",

  portsContact: "https://www.ports.je/about-us/contact/",
  airportContact: "https://www.jerseyairport.com/contact/contact-us/",

  libertyBus: "https://libertybus.je/"
};

/* -------------------------
   STATIC DIRECTORY
   ------------------------- */
const DIRECTORY_STATIC = [
  // Emergency
  {
    id:"emg-999",
    category:"Emergency",
    name:"Emergency services (999 / 112)",
    desc:"Police, Fire & Ambulance (life-threatening emergencies).",
    tags:["999","112","emergency"],
    phone:"999",
    links:[
      {label:"Official info (gov.je)", url:"https://www.gov.je/LifeEvents/MovingToJersey/WhenYouArrive/pages/contactemergencyservices.aspx"}
    ],
    mapsQuery:"Jersey General Hospital Emergency Department"
  },

  // Pharmacies
  {
    id:"pharm-hours",
    category:"Pharmacies",
    name:"Pharmacy opening hours (official list)",
    desc:"Search opening hours by pharmacy.",
    tags:["opening hours","official"],
    links:[{label:"gov.je list", url:"https://www.gov.je/Health/DoctorDentist/PharmacistsChemists/pages/pharmacyopeninghours.aspx"}],
    mapsQuery:"Pharmacy St Helier Jersey"
  },

  // Ports & Airport
  {
    id:"ports-contact",
    category:"Ports & Airport",
    name:"Ports of Jersey ‚Äî contact",
    desc:"Airport & Harbours general enquiries.",
    tags:["ports","airport","harbour"],
    phone:"+44 1534 446000",
    email:"customerrelations@ports.je",
    links:[{label:"ports.je contact", url: LINKS.portsContact}],
    mapsQuery:"Ports of Jersey"
  },
  {
    id:"airport-contact",
    category:"Ports & Airport",
    name:"Jersey Airport ‚Äî contact",
    desc:"Airport contact page (official).",
    tags:["airport"],
    links:[{label:"Airport contact", url: LINKS.airportContact}],
    mapsQuery:"Jersey Airport"
  },

  // Bus & Taxis
  {
    id:"libertybus",
    category:"Bus & Taxis",
    name:"LibertyBus",
    desc:"Routes, timetables, tickets (official).",
    tags:["bus","timetable"],
    phone:"01534 828F? (check website)",
    links:[
      {label:"libertybus.je", url: LINKS.libertyBus},
      {label:"Routes & timetables (gov.je)", url:"https://www.gov.je/Travel/Buses/Pages/RoutesTimetables.aspx"}
    ],
    mapsQuery:"Liberation Station St Helier"
  },

  // Museums & Heritage (Jersey Heritage + National Trust)
  {
    id:"heritage-places",
    category:"Museums & Heritage",
    name:"Jersey Heritage ‚Äî places to visit",
    desc:"Official list of museums, castles and heritage sites.",
    tags:["heritage","museums","castles"],
    links:[{label:"Places list", url: LINKS.heritagePlaces}],
    mapsQuery:"Jersey Museum St Helier"
  },
  {
    id:"museum-jersey",
    category:"Museums & Heritage",
    name:"Jersey Museum, Art Gallery & Victorian House",
    desc:"Jersey Heritage ‚Äî entry and info page.",
    tags:["museum","art","victorian house"],
    links:[{label:"Jersey Museum page", url: LINKS.jerseyMuseum}],
    mapsQuery:"Jersey Museum St Helier"
  },
  {
    id:"museum-maritime",
    category:"Museums & Heritage",
    name:"Maritime Museum & Occupation Tapestry Gallery",
    desc:"Jersey Heritage ‚Äî museum page + tickets.",
    tags:["maritime","occupation tapestry"],
    links:[{label:"Maritime Museum page", url: LINKS.maritimeMuseum}],
    mapsQuery:"Maritime Museum St Helier"
  },
  {
    id:"heritage-hamptonne",
    category:"Museums & Heritage",
    name:"Hamptonne Country Life Museum",
    desc:"Historic farm estate and rural life museum.",
    tags:["hamptonne","country life"],
    links:[
      {label:"Jersey Heritage page", url: LINKS.hamptonne},
      {label:"National Trust page", url: LINKS.ntHamptonne}
    ],
    mapsQuery:"Hamptonne Country Life Museum"
  },
  {
    id:"heritage-whats-on",
    category:"Museums & Heritage",
    name:"Jersey Heritage ‚Äî what‚Äôs on",
    desc:"Tours, exhibitions and heritage events.",
    tags:["events","exhibitions"],
    links:[{label:"What‚Äôs on", url: LINKS.heritageWhatsOn}],
    mapsQuery:"Mont Orgueil Castle"
  },
  {
    id:"nt-sites",
    category:"Museums & Heritage",
    name:"National Trust for Jersey ‚Äî historic buildings",
    desc:"Historic houses, mills, landscapes and more.",
    tags:["national trust","historic buildings"],
    links:[
      {label:"National Trust", url: LINKS.nationalTrust},
      {label:"Historic buildings", url: LINKS.nationalTrustBuildings}
    ],
    mapsQuery:"The Elms Jersey"
  },

  // Activities (Visit Jersey)
  {
    id:"visit-things",
    category:"Activities",
    name:"Things to do (Visit Jersey)",
    desc:"Official tourism guide: inspiration, indoor/outdoor ideas.",
    tags:["things to do","guide"],
    links:[{label:"Things to do", url: LINKS.visitThings}],
    mapsQuery:"Jersey things to do"
  },
  {
    id:"visit-attractions",
    category:"Activities",
    name:"Top attractions (Visit Jersey)",
    desc:"Attractions list: family, gardens, animals, tunnels, etc.",
    tags:["attractions","family"],
    links:[{label:"Attractions", url: LINKS.visitAttractions}],
    mapsQuery:"Jersey attractions"
  },
  {
    id:"visit-events",
    category:"Activities",
    name:"What‚Äôs on / Events (Visit Jersey)",
    desc:"Events overview + listings.",
    tags:["events","festivals"],
    links:[
      {label:"Events", url: LINKS.visitEvents},
      {label:"Event listings", url: LINKS.visitEventsListings}
    ],
    mapsQuery:"St Helier events"
  }
];

/* -------------------------
   TRUE Parking LIVE (gov JSON)
   ------------------------- */
const LIVE_FALLBACK = [
  { code:"CHARLESSTREET", name:"Charles Street", type:"Short stay", mapsQuery:"Charles Street car park St Helier Jersey" },
  { code:"GREENST", name:"Green Street", type:"Long stay", mapsQuery:"Green Street car park St Helier Jersey" },
  { code:"LESJARDIN", name:"Les Jardin", type:"Long stay", mapsQuery:"Les Jardin car park St Helier Jersey" },
  { code:"MINDENPL", name:"Minden Place", type:"Short stay", mapsQuery:"Minden Place car park St Helier Jersey" },
  { code:"PATRIOTICST", name:"Patriotic Street", type:"Long stay", mapsQuery:"Patriotic Street car park St Helier Jersey" },
  { code:"PIERRD", name:"Pier Road", type:"Long stay", mapsQuery:"Pier Road car park St Helier Jersey" },
  { code:"SANDST", name:"Sand Street", type:"Short stay", mapsQuery:"Sand Street car park St Helier Jersey" }
];

let LIVE_SPACES = LIVE_FALLBACK.map(x => ({...x, spaces:"‚Äî", open:true, status:"good"}));
let LIVE_TIMESTAMP = "";

function spacesNum(x){
  const n = Number(String(x.spaces).replace(/[^\d]/g,""));
  return Number.isFinite(n) ? n : -1;
}
function spacesBadgeHTML(n){
  if(n < 0) return `<span class="pill">Spaces: ‚Äî</span>`;
  if(n >= 200) return `<span class="pill good">Spaces: ${n}</span>`;
  if(n >= 80)  return `<span class="pill warn">Spaces: ${n}</span>`;
  return `<span class="pill bad">Spaces: ${n}</span>`;
}

function buildLiveParkingServices(){
  const sorted = [...LIVE_SPACES].sort((a,b)=> spacesNum(b) - spacesNum(a));
  return sorted.map(x => {
    const n = spacesNum(x);
    const openText = x.open ? "Open" : "Closed";
    const typeText = x.type ? ` ‚Ä¢ ${x.type}` : "";
    return ({
      id: "live-" + x.code,
      category: "Parking LIVE",
      name: `${x.name}`,
      desc: `${openText}${typeText} ‚Ä¢ ${x.spaces} spaces`,
      tags: ["live", "spaces", x.type || ""].filter(Boolean),
      pillHTML: spacesBadgeHTML(n),
      links: [
        { label:"Official LIVE page (gov.je)", url: LINKS.govLivePage },
        { label:"PayByPhone info (gov.je)", url: LINKS.payByPhone }
      ],
      mapsQuery: x.mapsQuery
    });
  });
}

/* -------------------------
   All services
   ------------------------- */
function allServices(){
  return [
    ...buildLiveParkingServices(),
    ...DIRECTORY_STATIC
  ];
}

/* -------------------------
   Filter/search
   ------------------------- */
function matchesQuery(svc, q){
  if(!q) return true;
  const hay = [
    svc.name, svc.desc, svc.category,
    ...(svc.tags||[]),
    svc.phone||"",
    svc.email||"",
    ...(svc.links||[]).map(x=>x.label+" "+x.url),
    svc.mapsQuery||""
  ].join(" ");
  return norm(hay).includes(norm(q));
}

function visibleServices(){
  return allServices()
    .filter(s => state.category === "All" ? true : s.category === state.category)
    .filter(s => state.showFavs ? state.favs.has(s.id) : true)
    .filter(s => matchesQuery(s, state.q));
}

/* -------------------------
   Render
   ------------------------- */
function renderCats(){
  const merged = allServices();
  const counts = merged.reduce((acc, s)=>{ acc[s.category]=(acc[s.category]||0)+1; return acc; },{});
  const cats = ["All", ...CATEGORY_ORDER.filter(c => counts[c])];

  $("cats").innerHTML = cats.map(cat=>{
    const count = cat==="All" ? merged.length : (counts[cat]||0);
    const active = (state.category===cat) ? "active" : "";
    return `
      <div class="cat ${active}" data-cat="${escapeHtml(cat)}">
        <div class="catLeft">
          <div class="catIcon">${catIcon(cat)}</div>
          <div class="catName">${escapeHtml(cat)}</div>
        </div>
        <div class="badge catCount">${count}</div>
      </div>
    `;
  }).join("");

  [...document.querySelectorAll(".cat[data-cat]")].forEach(el=>{
    el.addEventListener("click", ()=>{
      state.category = el.getAttribute("data-cat");
      renderAll(false);
    });
  });
}

function renderHeader(){
  const list = visibleServices();
  const title = (state.category==="All") ? "All services" : state.category;
  $("viewTitle").textContent = `${title} (${list.length})`;

  const descByCat = {
    "Parking LIVE": "Official live spaces (auto-refresh). Tap each car park for maps + official links.",
    "Museums & Heritage": "Museums, castles and heritage sites (official sources).",
    "Activities": "Top attractions and what‚Äôs on (official tourism site).",
    "Ports & Airport": "Ports, harbours and airport contacts.",
    "Bus & Taxis": "Buses and taxi info.",
    "Pharmacies": "Official pharmacy opening hours + contacts.",
    "Emergency": "Emergency numbers and guidance."
  };
  $("viewDesc").textContent = state.showFavs ? "Your saved services for one-tap access." : (descByCat[state.category] || "One-tap actions: Call ‚Ä¢ Email ‚Ä¢ Maps ‚Ä¢ Official pages.");

  const liveText = LIVE_TIMESTAMP ? ` ‚Ä¢ Updated: ${LIVE_TIMESTAMP}` : "";
  $("statsLine").textContent = `Showing ${list.length} ‚Ä¢ Live refresh ~2 minutes${liveText}`;

  $("countVisible").textContent = list.length;
}

function renderCards(){
  const list = visibleServices();
  const el = $("cards");

  if(!list.length){
    el.innerHTML = `
      <div class="card" style="grid-column:1/-1;">
        <div class="name">No results</div>
        <div class="meta">Try: ‚Äúspaces‚Äù, ‚Äúmuseum‚Äù, ‚Äúcastle‚Äù, ‚Äúevents‚Äù, ‚Äútaxi‚Äù, ‚Äúairport‚Äù.</div>
      </div>
    `;
    return;
  }

  el.innerHTML = list.map(s=>{
    const isFav = state.favs.has(s.id);
    const tags = (s.tags||[]).slice(0,10).map(t=>`<span class="tag">${escapeHtml(String(t))}</span>`).join("");

    const phoneBtn = s.phone && String(s.phone).includes("check") ? "" : (s.phone ? `<a class="chip" href="${telHref(s.phone)}">üìû Call</a>` : "");
    const emailBtn = s.email ? `<a class="chip" href="${mailHref(s.email)}">‚úâÔ∏è Email</a>` : "";
    const mapsBtn = `<a class="chip" href="${mapsUrl(s.mapsQuery || (s.name + " Jersey"))}" target="_blank" rel="noopener">üó∫Ô∏è Maps</a>`;
    const links = (s.links||[]).slice(0,4).map(l=>`<a class="chip primary" href="${l.url}" target="_blank" rel="noopener">‚Üó ${escapeHtml(l.label)}</a>`).join("");

    const pill = s.pillHTML ? `<div style="margin-top:6px;">${s.pillHTML}</div>` : "";

    return `
      <div class="card">
        <div class="row">
          <div>
            <div class="name">${escapeHtml(s.name)}</div>
            <div class="meta">${escapeHtml(s.desc || "")}</div>
            ${pill}
          </div>
          <button class="favBtn ${isFav ? "on" : ""}" data-fav="${escapeHtml(s.id)}">${isFav ? "‚òÖ" : "‚òÜ"}</button>
        </div>

        <div class="tags">${tags}</div>

        <div class="actions">
          ${phoneBtn}
          ${emailBtn}
          ${mapsBtn}
          ${links}
          <button class="chip" type="button" data-copy="${escapeHtml(s.id)}">üìã Copy</button>
        </div>
      </div>
    `;
  }).join("");

  [...document.querySelectorAll("[data-fav]")].forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const id = btn.getAttribute("data-fav");
      if(state.favs.has(id)){
        state.favs.delete(id);
        toast("Removed from favourites");
      }else{
        state.favs.add(id);
        toast("Saved to favourites");
      }
      localStorage.setItem(LS_FAVS, JSON.stringify([...state.favs]));
      renderAll(false);
    });
  });

  [...document.querySelectorAll("[data-copy]")].forEach(btn=>{
    btn.addEventListener("click", async ()=>{
      const id = btn.getAttribute("data-copy");
      const svc = allServices().find(x=>x.id===id);
      if(!svc) return;

      const firstLink = (svc.links && svc.links[0]) ? svc.links[0].url : "";
      const text = [
        svc.name,
        svc.desc || "",
        svc.phone ? ("Call: " + svc.phone) : "",
        svc.email ? ("Email: " + svc.email) : "",
        firstLink
      ].filter(Boolean).join("\n");

      try{
        await navigator.clipboard.writeText(text);
        toast("Copied");
      }catch{
        toast("Copy not supported");
      }
    });
  });
}

function renderAll(rerenderCats=true){
  if(rerenderCats) renderCats();
  renderHeader();
  renderCards();
}

/* -------------------------
   UI actions
   ------------------------- */
$("q").addEventListener("input", ()=>{
  state.q = $("q").value;
  renderAll(false);
});

$("favToggle").addEventListener("click", ()=>{
  state.showFavs = !state.showFavs;
  renderAll(false);
});

$("resetBtn").addEventListener("click", ()=>{
  state.q=""; $("q").value="";
  state.category="All";
  state.showFavs=false;
  renderAll(true);
});

$("nearMeBtn").addEventListener("click", ()=>{
  if(!navigator.geolocation){ toast("Geolocation not supported"); return; }
  toast("Getting location‚Ä¶");
  navigator.geolocation.getCurrentPosition(
    (pos)=>{
      const { latitude, longitude } = pos.coords;
      const url = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent("things to do")}&center=${latitude},${longitude}`;
      window.open(url, "_blank");
    },
    ()=> toast("Location blocked in browser settings"),
    { enableHighAccuracy:true, timeout: 10000 }
  );
});

/* -------------------------
   TRUE LIVE parking fetch (same feed used by gov.je)
   ------------------------- */
async function loadLiveSpaces(){
  const GOV_JSON = "https://sojpublicdata.blob.core.windows.net/sojpublicdata/carpark-data.json";

  try{
    $("liveStatus").textContent = "LIVE‚Ä¶";
    $("liveStatus").className = "badge liveWait";

    const res = await fetch(GOV_JSON, { cache:"no-store" });
    if(!res.ok) throw new Error("gov json failed");
    const data = await res.json();

    const carparks = data?.carparkData?.Jersey?.carpark || [];
    LIVE_TIMESTAMP = data?.carparkData?.Jersey?.Timestamp || "";

    const byCode = new Map(carparks.map(c => [String(c.code || "").toUpperCase(), c]));

    LIVE_SPACES = LIVE_FALLBACK.map(fb=>{
      const r = byCode.get(String(fb.code).toUpperCase());
      return {
        ...fb,
        spaces: (r && Number.isFinite(Number(r.spaces))) ? Number(r.spaces) : "‚Äî",
        open: r ? !!r.carparkOpen : true,
        status: r ? (r.status || "good") : "good"
      };
    });

    $("liveStatus").textContent = "LIVE ‚úì";
    $("liveStatus").className = "badge liveOk";
    renderAll(true);
  }catch(e){
    console.log("Live parking failed:", e);
    $("liveStatus").textContent = "LIVE ‚úï";
    $("liveStatus").className = "badge liveBad";
    renderAll(true);
  }
}

loadLiveSpaces();
setInterval(loadLiveSpaces, 120000);

/* -------------------------
   Service worker
   ------------------------- */
if("serviceWorker" in navigator){
  window.addEventListener("load", ()=>{
    navigator.serviceWorker.register("./sw.js").catch(()=>{});
  });
}

renderAll(true);
</script>
</body>
</html>
